<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Problems</title>
  <link rel="stylesheet" href="static/tree.css">
  <link rel="stylesheet" href="static/base.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/bitmaks/cm-web-fonts@latest/fonts.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdn.rawgit.com/dreampulse/computer-modern-web-font/master/fonts.css">
  <!-- Bootstrap CSS desde CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"></link>

  <script src="static/include.js" defer></script>
  <style>

  </style>

</head>

<body>

  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">

  </nav>

  <main class="container">

    <h1 class="text-center">Problem areas</h1>
    <div class="row">
      <div id="problems-container" class="col col-md-6">
        <!-- Se llena con JS -->
      </div>
      <div id="description-container" class="col col-md-6">
        <!-- Se llena con JS -->
      </div>
    </div>

    <!-- tooltip flotante -->
    <div id="tooltip" class="tooltip"></div>
    <div id="biblio">
      <!-- Se llena con JS -->
    </div>

  </main>

  <script>

    function setEventHandlers() {
      const tooltip = document.getElementById("tooltip");
      const descriptionDiv = document.getElementById("description-container");

      document.querySelectorAll("li.tooltipable").forEach(li => {
        li.addEventListener("mouseenter", e => {
          const id = li.getAttribute("data-tooltip");
          const contentDiv = document.getElementById(id);
          if (!contentDiv) return;

          tooltip.innerHTML = contentDiv.innerHTML;
          tooltip.classList.add("show");
        });

        li.addEventListener("mousemove", e => {
          tooltip.style.left = e.pageX + 10 + "px";
          tooltip.style.top = e.pageY + 10 + "px";
        });

        li.addEventListener("mouseleave", e => {
          tooltip.classList.remove("show");
        });

        li.addEventListener("click", e => {
          descriptionDiv.innerHTML = "";
          const id = li.getAttribute("data-tooltip");
          const contentDiv = document.getElementById(id);
          if (!contentDiv) return;
          descriptionDiv.innerHTML = descriptionDict[id.replace('nick-', '')];
        });

      });
    }
  </script>
  <script>
    //global const
    const descriptionDict = {};
    function sort_str(string_arr) {
      return string_arr.sort((a, b) => {
        if (typeof a === 'object' || typeof b === 'object') return 0; // no ordenar objetos
        return String(a).localeCompare(String(b));
      })
    }

    async function renderTree(file_url = 'tree.json', container_id = 'treeview') {
      const response = await fetch(file_url);
      const treeData = await response.json();

      const container = document.getElementById(container_id);

      tasks = sort_str(Object.keys(treeData));

      function createTree(data) {
        if (data === null || data === undefined) {
          return '';
        }

        // caso primitivo (string, número, booleano)
        if (typeof data !== 'object') {
          return `<li data-tooltip="nick-${data}" class="tooltipable">${data}</li>`;
        }

        let html = '<ul class="tree">';

        if (Array.isArray(data)) {
          // ordenar array (si los elementos son primitivos)
          const sortedArray = [...data].sort((a, b) => {
            if (typeof a === 'object' || typeof b === 'object') return 0; // no ordenar objetos
            return String(a).localeCompare(String(b));
          });

          for (const item of sortedArray) {
            html += createTree(item);
          }
        } else {
          // es diccionario → ordenar claves
          const keys = Object.keys(data).sort((a, b) => a.localeCompare(b));

          for (const key of keys) {
            const value = data[key];
            if (typeof value === 'object' && value !== null) {
              html += `<li>
                <details>
                  <summary>${key}</summary>
                  ${createTree(value)}
                </details>
              </li>`;
            } else {
              html += `<li data-tooltip="nick-${value}">${key}: ${value}</li>`;
            }
          }
        }

        html += '</ul>';
        return html;
      }


      container.innerHTML = createTree(treeData);

      setEventHandlers();
    }

    renderTree('data/problems.json', 'problems-container');

    async function renderBib(file_url = 'bib.json', container_id = 'treeview') {

      const container = document.getElementById(container_id);
      var res = await fetch(file_url);
      bibData = await res.json();

      // load bibData (a list of objects)
      let html = '<div class="hide" style="display:none">';
      const sortedArray = [...bibData].sort((a, b) => {
        if (typeof a === 'object' || typeof b === 'object') return 0; // no ordenar objetos
        return String(a).localeCompare(String(b));
      });
      for (const entry of sortedArray) {
        html += `<div id="nick-${entry.ID}">${entry.author} (${entry.year}). <i>${entry.title}</i>.
          <br> ${entry.publisher}. <br> <a href="${entry.url}" target="_blank">[link]</a></div>`;


        descriptionDict[entry.ID] = `<h3>${entry.title}</h3>
        <p><strong>Authors:</strong> ${entry.author}</p>
        <p><strong>Year:</strong> ${entry.year}</p>
        <p><strong>Link:</strong> <a href="${entry.url}" target="_blank">${entry.url}</a></p>`;
        // dinamically add every other entry fields
        keys = Object.keys(entry).filter(k => !['ID', 'author', 'year', 'title', 'url'].includes(k));
        for (const key of keys) {
          descriptionDict[entry.ID] += `<p><strong>${key.charAt(0).toUpperCase() + key.slice(1)}:</strong> ${entry[key]}</p>`;
        }

      }
      html += '</div>';
      container.innerHTML = html;


    }

    renderBib('data/bib.json', 'biblio');

  </script>



</body>

</html>