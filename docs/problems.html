<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Problems</title>
  <link rel="stylesheet" href="static/tree.css">
  <link rel="stylesheet" href="static/base.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/bitmaks/cm-web-fonts@latest/fonts.css">
  <link rel="stylesheet" type="text/css"
    href="https://cdn.rawgit.com/dreampulse/computer-modern-web-font/master/fonts.css">
  <!-- Bootstrap CSS desde CDN -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"></link>

  <script src="static/include.js" defer></script>
  <style>
  img.figure { border: 1px black solid; max-width:100%; height:auto; }
  </style>

</head>

<body>

  <!-- Barra de navegación -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">

  </nav>

  <main class="container">

    <h1 class="text-center">Problem areas</h1>
    <div class="row">
      <div id="problems-container" class="col col-md-6">
        <!-- Se llena con JS -->
      </div>
      <div id="description-container" class="col col-md-6">
        <!-- Se llena con JS -->
      </div>
    </div>

    <!-- tooltip flotante -->
    <div id="tooltip" class="tooltip"></div>
    <div id="tooltip-container" style="position: fixed; pointer-events: none; z-index: 1000;"></div>

    <div id="biblio">
      <!-- Se llena con JS -->
    </div>

  </main>

  <script>

    function setEventHandlers() {
      const tooltipContainer = document.getElementById('tooltip-container');
      const descriptionDiv = document.getElementById("description-container");

      document.querySelectorAll("li.tooltipable").forEach(li => {
        li.addEventListener('mouseenter', function(event) {
          const key = event.target.getAttribute('data-tooltip').replace('nick-', '');
          

          if (key && bib_data.hasOwnProperty(key)) {
            const bibEntry = bib_data[key];
            
            // Clear previous tooltips
            tooltipContainer.innerHTML = '';
            
            // Create tooltip element
            const tooltip = document.createElement('div');
            //tooltip.className = 'tooltip';
            tooltip.style.position = 'fixed';
            tooltip.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            tooltip.style.color = 'white';
            tooltip.style.padding = '8px';
            tooltip.style.borderRadius = '4px';
            tooltip.style.maxWidth = '600px';
            tooltip.style.fontSize = '0.9em';
            tooltip.style.whiteSpace = 'normal';
            tooltip.style.wordWrap = 'break-word';
            

            // Fill tooltip content
            let content = '';
            if (bibEntry.title) {
              // remove curly braces from title
              const title = bibEntry.title.replace(/[{}]/g, '');
              content += `<strong>Title:</strong> ${title}<br>`;
            }
            if (bibEntry.authors) {
              content += `<strong>Authors:</strong> ${bibEntry.authors}<br>`;
            }

            // Position the tooltip
            tooltip.style.left = (event.clientX + 10) + 'px';
            tooltip.style.top = (event.clientY + 10) + 'px';
            tooltip.innerHTML = content;

            //document.getElementById('details-container').innerHTML = content;


            tooltipContainer.appendChild(tooltip);
          }
        });

        
        li.addEventListener('mouseout', e => { tooltipContainer.innerHTML = ''; });
        

        li.addEventListener("click", e => {
          descriptionDiv.innerHTML = "";
          var id = li.getAttribute("data-tooltip");

          //const contentDiv = document.getElementById(id);
          //if (!contentDiv) return;
          id = id.replace('nick-', '').trim();

          taskData = globalTasks['data'][id];
          if (taskData) {
            taskHtml = `<h2>Tool: ${id} </h2><ul>`;
            taskHtml += `<li><strong>LLM Downstream task</strong>: ${taskData.html}</li>`;
            if (taskData.architectural_notes) {
              taskHtml += `<li><strong>Architectural notes:</strong> ${taskData.architectural_notes}</li>`;
            }
            if (taskData.diagram) {
              taskHtml += `<li><strong>Diagram:</strong> <br><img src="data/${taskData.diagram}" class="figure" alt="Diagram for ${id}"></li>`;
            }
            taskHtml += '</ul>';
            descriptionDiv.innerHTML += taskHtml;
          }

          key = id;
          if (key && bib_data.hasOwnProperty(key)) {
            const bibEntry = bib_data[key];

            // Fill tooltip content
            let content = '<h3>Bibliographic Info</h3> <strong>Tool:</strong> ' + key + '<br>';
            if (bibEntry.title) {
              const title = bibEntry.title.replace(/[{}]/g, '');
              content += `<strong>Title:</strong> ${title}<br>`;
            }
            if (bibEntry.authors) {
              content += `<strong>Authors:</strong> ${bibEntry.authors}<br>`;
            }
            if (bibEntry.href_url) {
              content += `<strong>Link:</strong> <a href="${bibEntry.href_url}" target="_blank">${bibEntry.href_url}</a><br>`;
            }

            descriptionDiv.innerHTML += content;
          }          
        });

      });
    }
  </script>
  <script>
    //global const
    const descriptionDict = {};
    const globalTasks = {};
    function sort_str(string_arr) {
      return string_arr.sort((a, b) => {
        if (typeof a === 'object' || typeof b === 'object') return 0; // no ordenar objetos
        return String(a).localeCompare(String(b));
      })
    }

    async function renderTree(file_url = 'tree.json', container_id = 'treeview') {
      const response = await fetch(file_url);
      const treeData = await response.json();

      const container = document.getElementById(container_id);

      let tasks = sort_str(Object.keys(treeData));

      function createTree(data) {
        if (data === null || data === undefined) {
          return '';
        }

        // caso primitivo (string, número, booleano)
        if (typeof data !== 'object') {
          return `<li data-tooltip="nick-${data}" class="tooltipable">${data}</li>`;
        }

        let html = '<ul class="tree">';

        if (Array.isArray(data)) {
          // ordenar array (si los elementos son primitivos)
          const sortedArray = [...data].sort((a, b) => {
            if (typeof a === 'object' || typeof b === 'object') return 0; // no ordenar objetos
            return String(a).localeCompare(String(b));
          });

          for (const item of sortedArray) {
            html += createTree(item);
          }
        } else {
          // es diccionario → ordenar claves
          const keys = Object.keys(data).sort((a, b) => a.localeCompare(b));

          for (const key of keys) {
            const value = data[key];
            if (typeof value === 'object' && value !== null) {
              html += `<li>
                <details>
                  <summary>${key}</summary>
                  ${createTree(value)}
                </details>
              </li>`;
            } else {
              html += `<li data-tooltip="nick-${value}">${key}: ${value}</li>`;
            }
          }
        }

        html += '</ul>';
        return html;
      }

      container.innerHTML = createTree(treeData);
      setEventHandlers();
    }

    // read data/bib_parsed.json
    const bib_data = {};
    async function readBibData(filename) {
      const response = await fetch(filename);
      const data = await response.json();
      Object.assign(bib_data, data);      
    }

    async function renderTasks(file_url = 'bib.json') {
      var res = await fetch(file_url);
      taskData = await res.json();

      globalTasks['data'] = taskData;
    }

    renderTree('data/problems.json', 'problems-container');
    readBibData('data/bib_parsed.json');
    renderTasks('data/task_dict.json');

  </script>



</body>

</html>
